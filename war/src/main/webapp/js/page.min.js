/*
 * Copyright (c) 2009, 2010, 2011, 2012, B3log Team
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @fileoverview Page util, load heighlight and process comment.
 *
 * @author <a href="mailto:LLY219@gmail.com">Liyuan Li</a>
 * @author <a href="mailto:DL88250@gmail.com">Liang Ding</a>
 * @version 1.0.3.1, Jul 5, 2012
 */var Page=function(e){this.currentCommentId="",this.tips=e};$.extend(Page.prototype,{insertEmotions:function(e){var t=this;e===undefined&&(e=""),$("#emotions"+e+" span").click(function(){var n=$("#comment"+e),r=t._getCursorEndPosition(n[0]),i="["+this.className+"]",s=n[0].value;s=s.substring(0,r)+i+s.substring(r,s.length),$("#comment"+e).val(s);if($.browser.msie){r-=s.split("\n").length-1;var o=n[0].createTextRange();o.collapse(!0),o.moveStart("character",r+6),o.select()}else n[0].setSelectionRange(r+6,r+6)})},_getCursorEndPosition:function(e){e.focus();if(e.setSelectionRange)return e.selectionEnd;if(document.selection){var t=0,n=document.selection.createRange(),r=document.body.createTextRange();r.moveToElementText(e),n.getBookmark();for(t=0;r.compareEndPoints("StartToStart",n)<0&&n.moveStart("character",-1)!==0;t++)e.value.charAt(t)=="\n"&&t++;return t}},validateComment:function(e){var t=$("#commentName"+e).val().replace(/(^\s*)|(\s*$)/g,""),n=$("#comment"+e).val().replace(/(^\s*)|(\s*$)/g,"");if(2>t.length||t.length>20)$("#commentErrorTip"+e).html(this.tips.nameTooLongLabel),$("#commentName"+e).focus();else if($("#commentEmail"+e).val().replace(/\s/g,"")==="")$("#commentErrorTip"+e).html(this.tips.mailCannotEmptyLabel),$("#commentEmail"+e).focus();else if(!/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i.test($("#commentEmail"+e).val()))$("#commentErrorTip"+e).html(this.tips.mailInvalidLabel),$("#commentEmail"+e).focus();else if(2>n.length||n.length>500)$("#commentErrorTip"+e).html(this.tips.commentContentCannotEmptyLabel),$("#comment"+e).focus();else{if($("#commentValidate"+e).val().replace(/\s/g,"")!=="")return!0;$("#commentErrorTip"+e).html(this.tips.captchaCannotEmptyLabel),$("#commentValidate"+e).focus()}return $("#commentErrorTip"+e).show(),!1},replaceCommentsEm:function(e){var t=$(e);for(var n=0;n<t.length;n++){var r=t[n].innerHTML;t[n].innerHTML=Util.replaceEmString(r)}},_initSyntaxHighlighter:function(e){for(var t=0;t<e.length;t++)switch(e[t]){case"groovy":e[t]="groovy				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushGroovy.js";break;case"java":e[t]="java				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushJava.js";break;case"php":e[t]="php				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushPhp.js";break;case"scala":e[t]="scala				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushScala.js";break;case"sql":e[t]="sql				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushSql.js";break;case"applescript":e[t]="applescript			"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushAppleScript.js";break;case"as3":case"actionscript3":e[t]="actionscript3 as3                  "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushAS3.js";break;case"bash":case"shell":e[t]="bash shell                         "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushBash.js";break;case"coldfusion":case"cf":e[t]="coldfusion cf			"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushColdFusion.js";break;case"c#":case"c-sharp":case"csharp":e[t]="c# c-sharp csharp                  "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushCSharp.js";break;case"cpp":case"c":e[t]="cpp c				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushCpp.js";break;case"css":e[t]="css				"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushCss.js";break;case"delphi":case"pascal":e[t]="delphi pascal			"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushDelphi.js";break;case"diff":case"patch":case"pas":e[t]="diff patch pas			"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushDiff.js";break;case"erl":case"erlang":e[t]="erl erlang                         "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushErlang.js";break;case"js":case"jscript":case"javascript":e[t]="js jscript javascript              "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushJScript.js";break;case"jfx":case"javafx":e[t]="jfx javafx                 	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushJavaFX.js";break;case"perl":case"pl":e[t]="perl pl                    	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushPerl.js";break;case"plain":case"text":e[t]="text plain                 	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushPlain.js";break;case"ps":case"powershell":e[t]="ps powershell                      "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushPowerShell.js";break;case"py":case"python":e[t]="py python                          "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushPython.js";break;case"rails":case"ror":case"ruby":case"rb":e[t]="ruby rails ror rb          	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushRuby.js";break;case"sass":case"scss":e[t]="sass scss                  	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushSass.js";break;case"vb":case"vbnet":e[t]="vb vbnet                   	"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushVb.js";break;case"xml":case"xhtml":case"xslt":case"html":e[t]="xml xhtml xslt html                "+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushXml.js";break;default:}SyntaxHighlighter.autoloader.apply(null,e),SyntaxHighlighter.config.stripBrs=!0,SyntaxHighlighter.all()},_loadSyntaxHighlighter:function(e){var t=e?e:"shCoreEclipse",n=this;document.createStyleSheet?document.createStyleSheet(latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/styles/"+t+".css"):$("head").append($("<link rel='stylesheet' href='"+latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/styles/"+t+".css' type='text/css' charset='utf-8' />")),$.ajax({url:latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shCore.js",dataType:"script",cache:!0,success:function(){var e=[],t=!1;$(".article-body pre").each(function(){var n=this.className.split(";")[0],r=n.substr(7,n.length-1);this.className.indexOf("html-script: true")>-1&&r!=="xml"&&r!=="xhtml"&&r!=="xslt"&&r!="html"&&(t=!0),e.push(r)}),t?$.ajax({url:latkeConfig.staticServePath+"/js/lib/SyntaxHighlighter/scripts/shBrushXml.js",dataType:"script",cache:!0,success:function(){n._initSyntaxHighlighter(e)}}):n._initSyntaxHighlighter(e)}})},parseLanguage:function(e){var t=!1,n=!1;$(".article-body pre").each(function(){this.className.indexOf("brush")>-1&&(n=!0),this.className.indexOf("prettyprint")>-1&&(t=!0)}),n&&this._loadSyntaxHighlighter(e?e.SHTheme?e.SHTheme:undefined:undefined),t&&(document.createStyleSheet?document.createStyleSheet(latkeConfig.staticServePath+"/js/lib/google-code-prettify/prettify.css"):$("head").append($("<link rel='stylesheet' href='"+latkeConfig.staticServePath+"/js/lib/google-code-prettify/prettify.css'>")),document.write('<script src="'+latkeConfig.staticServePath+'/js/lib/google-code-prettify/prettify.js"></script>'),$(document).ready(function(){prettyPrint()}))},load:function(e){var t=this;t.insertEmotions(),t.parseLanguage(e?e.language?e.language:undefined:undefined),$("#commentValidate").keypress(function(e){e.keyCode===13&&t.submitComment()}),$("#captcha").click(function(){$(this).attr("src",latkeConfig.servePath+"/captcha.do?code="+Math.random())});var n=$("#top #admin");n.length===1&&n.find("a").length>2&&(Cookie.readCookie("commentName")===""&&Cookie.createCookie("commentName",n.find("span").text(),365),Cookie.readCookie("commentURL")===""&&Cookie.createCookie("commentURL",window.location.host,365)),$("#commentEmail").val(Cookie.readCookie("commentEmail")),$("#commentURL").val(Cookie.readCookie("commentURL")),$("#commentName").val(Cookie.readCookie("commentName"))},loadRandomArticles:function(e){var t=this.tips.randomArticles1Label;$.ajax({url:latkeConfig.staticServePath+"/get-random-articles.do",type:"POST",success:function(n,r){var i=n.randomArticles;if(!i||0===i.length){$("#randomArticles").remove();return}var s="";for(var o=0;o<i.length;o++){var u=i[o],a=u.articleTitle,f="<li><a rel='nofollow' title='"+a+"' href='"+u.articlePermalink+"'>"+a+"</a></li>";s+=f}var l=e?e:"<h4>"+t+"</h4>",c=l+"<ul class='marginLeft12'>"+s+"</ul>";$("#randomArticles").append(c)}})},loadRelevantArticles:function(e,t){$.ajax({url:latkeConfig.staticServePath+"/article/id/"+e+"/relevant/articles",type:"GET",success:function(e,n){var r=e.relevantArticles;if(!r||0===r.length){$("#relevantArticles").remove();return}var i="";for(var s=0;s<r.length;s++){var o=r[s],u=o.articleTitle,a="<li><a rel='nofollow' title='"+u+"' href='"+o.articlePermalink+"'>"+u+"</a></li>";i+=a}var f=t+"<ul class='marginLeft12'>"+i+"</ul>";$("#relevantArticles").append(f)},error:function(){$("#relevantArticles").remove()}})},loadExternalRelevantArticles:function(e,t){var n=this.tips;try{$.ajax({url:"http://rhythm.b3log.org:80/get-articles-by-tags.do?tags="+e+"&blogHost="+n.blogHost+"&paginationPageSize="+n.externalRelevantArticlesDisplayCount,type:"GET",cache:!0,dataType:"jsonp",error:function(){$("#externalRelevantArticles").remove()},success:function(e,r){var i=e.articles;if(!i||0===i.length){$("#externalRelevantArticles").remove();return}var s="";for(var o=0;o<i.length;o++){var u=i[o],a=u.articleTitle,f="<li><a rel='nofollow' title='"+a+"' target='_blank' href='"+u.articlePermalink+"'>"+a+"</a></li>";s+=f}var l=t?t:"<h4>"+n.externalRelevantArticles1Label+"</h4>",c=l+"<ul class='marginLeft12'>"+s+"</ul>";$("#externalRelevantArticles").append(c)}})}catch(r){}},submitComment:function(e,t){t||(t="");var n=this,r=this.tips,i="article";r.externalRelevantArticlesDisplayCount===undefined&&(i="page");if(this.validateComment(t)){$("#submitCommentButton"+t).attr("disabled","disabled"),$("#commentErrorTip"+t).show().html(this.tips.loadingLabel);var s={oId:r.oId,commentContent:$("#comment"+t).val().replace(/(^\s*)|(\s*$)/g,""),commentEmail:$("#commentEmail"+t).val(),commentURL:Util.proessURL($("#commentURL"+t).val().replace(/(^\s*)|(\s*$)/g,"")),commentName:$("#commentName"+t).val().replace(/(^\s*)|(\s*$)/g,""),captcha:$("#commentValidate"+t).val()};t==="Reply"&&(s.commentOriginalCommentId=e),$.ajax({type:"POST",url:latkeConfig.servePath+"/add-"+i+"-comment.do",cache:!1,contentType:"application/json",data:JSON.stringify(s),success:function(e){if(!e.sc){$("#commentErrorTip"+t).html(e.msg),$("#commentValidate"+t).val("").focus(),$("#submitCommentButton"+t).removeAttr("disabled"),$("#captcha"+t).attr("src",latkeConfig.servePath+"/captcha.do?code="+Math.random());return}e.replyNameHTML="",$("#commentURL"+t).val().replace(/\s/g,"")===""?e.replyNameHTML="<a>"+$("#commentName"+t).val()+"</a>":e.replyNameHTML='<a href="'+Util.proessURL($("#commentURL"+t).val())+'" target="_blank">'+$("#commentName"+t).val()+"</a>",n.addCommentAjax(addComment(e,t),t),$("#submitCommentButton"+t).removeAttr("disabled"),$("#captcha"+t).attr("src",latkeConfig.servePath+"/captcha.do?code="+Math.random())}}),Cookie.createCookie("commentName",s.commentName,365),Cookie.createCookie("commentEmail",s.commentEmail,365),Cookie.createCookie("commentURL",$("#commentURL"+t).val().replace(/(^\s*)|(\s*$)/g,""),365)}},addReplyForm:function(e,t,n){var r=this;if(e===this.currentCommentId){Cookie.readCookie("commentName")===""?$("#commentNameReply").focus():$("#commentReply").focus();return}$("#replyForm").remove(),n=n?n:"",n==="</div>"?$("#"+e).append(t+$("#commentForm").html()+n):$("#"+e).append(t+$("#commentForm").html()+"</table>"+n),$("#replyForm input, #replyForm textarea").each(function(){this.id=this.id+"Reply"}),$("#commentNameReply").val(Cookie.readCookie("commentName")),$("#commentEmailReply").val(Cookie.readCookie("commentEmail"));var i=$("#replyForm #commentURLLabel");i.length===1&&i.attr("id","commentURLLabelReply"),$("#commentURLReply").val(Cookie.readCookie("commentURL")),$("#replyForm #emotions").attr("id","emotionsReply"),this.insertEmotions("Reply"),$("#commentValidateReply").unbind().keypress(function(t){t.keyCode===13&&(r.submitComment(e,"Reply"),t.preventDefault())}),$("#replyForm #captcha").attr("id","captchaReply").attr("src",latkeConfig.servePath+"/captcha.do?"+(new Date).getTime()).click(function(){$(this).attr("src",latkeConfig.servePath+"/captcha.do?code="+Math.random())}),$("#replyForm #commentErrorTip").attr("id","commentErrorTipReply").html("").hide(),$("#replyForm #submitCommentButton").attr("id","submitCommentButtonReply"),$("#replyForm #submitCommentButtonReply").unbind("click").removeAttr("onclick").click(function(){r.submitComment(e,"Reply")}),Cookie.readCookie("commentName")===""?$("#commentNameReply").focus():$("#commentReply").focus(),this.currentCommentId=e},hideComment:function(e){$("#commentRef"+e).hide()},showComment:function(e,t,n,r){var i=parseInt($(e).position().top);r&&(i=parseInt($(e).parents(r).position().top));if($("#commentRef"+t).length>0)$("#commentRef"+t).show().css("top",i+n+"px");else{var s=$("#"+t).clone();s.addClass("comment-body-ref").attr("id","commentRef"+t),s.find("#replyForm").remove(),$("#comments").append(s),$("#commentRef"+t).css("top",i+n+"px")}},addCommentAjax:function(e,t){$("#comments").children().length>0?$($("#comments").children()[0]).before(e):$("#comments").html(e),t===""?($("#commentErrorTip").html("").hide(),$("#comment").val(""),$("#commentValidate").val(""),$("#captcha").attr("src",latkeConfig.servePath+"/captcha.do?code="+Math.random())):$("#replyForm").remove(),window.location.hash="#comments"}});